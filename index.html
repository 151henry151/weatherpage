<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard - GOES Satellite Animations</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <!-- Alerts Section -->
        <div id="alerts-container"></div>

        <!-- Weather Data Section -->
        <div class="weather-data">
            <div class="current-conditions">
                <div class="current-conditions-header">
                    <h2>CURRENT WEATHER<span id="current-zip"> (05753)</span></h2>
                    <button id="change-zip-btn">Change</button>
                </div>
                <div id="weather-info"></div>
                <div id="location-input-container" class="hidden">
                    <div class="location-input">
                        <input type="text" id="zipcode" placeholder="Enter ZIP Code">
                        <button id="update-zip-btn">Update</button>
                    </div>
                </div>
            </div>
            <div class="forecast">
                <h2>7-DAY FORECAST</h2>
                <div id="forecast-info">
                    <!-- Forecast details will be injected here -->
                </div>
            </div>
        </div>

        <div class="satellite-grid">
            <!-- CONUS GeoColor - Full Width -->
            <div class="satellite-item featured" data-band="GEOCOLOR" data-sector="CONUS">
                <a href="https://www.star.nesdis.noaa.gov/GOES/conus_band.php?sat=G19&band=GEOCOLOR&length=24" target="_blank">
                    <img src="" alt="CONUS GeoColor" class="satellite-image">
                    <div class="overlay-text">
                        <h3>CONUS GeoColor</h3>
                        <p>True color view of the US</p>
                    </div>
                </a>
            </div>

            <!-- Animated Forecast Maps -->
            <div class="forecast-anim forecast-temp">
                <a href="https://digital.weather.gov/?zoom=4&lat=37&lon=-96.5&layers=F00BTTTFFTT&region=0&element=0&mxmz=false&barbs=false&subl=TFFFFF&units=english&wunits=nautical&coords=latlon&tunits=localt" target="_blank">
                    <img id="temp-forecast-anim" src="" alt="Temperature Forecast Animation">
                    <div class="overlay-text">
                        <h3>Temperature Forecast</h3>
                        <p>7-Day Highs Animation</p>
                    </div>
                </a>
            </div>
            <div class="forecast-anim forecast-precip">
                <a href="https://digital.weather.gov/?zoom=4&lat=37&lon=-96.5&layers=F00BTTTFFTT&region=0&element=2&mxmz=false&barbs=false&subl=TFFFFF&units=english&wunits=nautical&coords=latlon&tunits=localt" target="_blank">
                    <img id="precip-forecast-anim" src="" alt="Precipitation Forecast Animation">
                    <div class="overlay-text">
                        <h3>Precipitation Forecast</h3>
                        <p>7-Day Precipitation Animation</p>
                    </div>
                </a>
            </div>

            <!-- Snow/Ice Detection -->
            <div class="satellite-item" data-band="05" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=05&length=24" target="_blank">
                    <img src="" alt="Snow/Ice Detection" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Snow/Ice Detection</h3>
                        <p>Band 5 - Near IR snow/ice</p>
                    </div>
                </a>
            </div>

            <!-- Day/Night Cloud Combo -->
            <div class="satellite-item" data-band="DayNightCloudMicroCombo" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=DayNightCloudMicroCombo&length=24" target="_blank">
                    <img src="" alt="Day/Night Cloud Combo" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Day/Night Cloud Combo</h3>
                        <p>Cloud reflectance / Low clouds & fog</p>
                    </div>
                </a>
            </div>

            <!-- Full Disk GeoColor -->
            <div class="satellite-item" data-band="GEOCOLOR" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=GEOCOLOR&length=24" target="_blank">
                    <img src="" alt="Full Disk GeoColor" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Full Disk GeoColor</h3>
                        <p>True color imagery - full hemisphere</p>
                    </div>
                </a>
            </div>

            <!-- Air Mass RGB -->
            <div class="satellite-item" data-band="AirMass" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=AirMass&length=24" target="_blank">
                    <img src="" alt="Air Mass RGB" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Air Mass RGB</h3>
                        <p>Composite from IR and WV bands</p>
                    </div>
                </a>
            </div>

            <!-- Sandwich RGB -->
            <div class="satellite-item" data-band="Sandwich" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=Sandwich&length=24" target="_blank">
                    <img src="" alt="Sandwich RGB" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Sandwich RGB</h3>
                        <p>Bands 3 & 13 combo</p>
                    </div>
                </a>
            </div>

            <!-- Ozone Detection -->
            <div class="satellite-item" data-band="12" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=12&length=24" target="_blank">
                    <img src="" alt="Ozone Detection" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Ozone Detection</h3>
                        <p>Band 12 - Atmospheric ozone</p>
                    </div>
                </a>
            </div>

            <!-- Lower Water Vapor -->
            <div class="satellite-item" data-band="10" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=10&length=24" target="_blank">
                    <img src="" alt="Lower Water Vapor" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Lower Water Vapor</h3>
                        <p>Band 10 - Lower atmosphere moisture</p>
                    </div>
                </a>
            </div>

            <!-- Mid Water Vapor -->
            <div class="satellite-item" data-band="09" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=09&length=24" target="_blank">
                    <img src="" alt="Mid Water Vapor" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Mid Water Vapor</h3>
                        <p>Band 9 - Mid atmosphere moisture</p>
                    </div>
                </a>
            </div>

            <!-- Upper Water Vapor -->
            <div class="satellite-item" data-band="08" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=08&length=24" target="_blank">
                    <img src="" alt="Upper Water Vapor" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Upper Water Vapor</h3>
                        <p>Band 8 - Upper atmosphere moisture</p>
                    </div>
                </a>
            </div>

            <!-- Dust RGB -->
            <div class="satellite-item" data-band="Dust" data-sector="FD">
                <a href="https://www.star.nesdis.noaa.gov/GOES/fulldisk_band.php?sat=G19&band=Dust&length=24" target="_blank">
                    <img src="" alt="Dust RGB" class="satellite-image">
                    <div class="overlay-text">
                        <h3>Dust RGB</h3>
                        <p>For identifying tropospheric dust</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <script>
        // NWS API Configuration
        const NWS_API_BASE = 'https://api.weather.gov';
        let currentLocation = { lat: 43.9998, lng: -73.1671 }; // Default to Middlebury, VT
        let currentZipCode = '05753'; // Default ZIP code for Middlebury, VT
        
        // Update ZIP code display
        function updateZipDisplay() {
            const zipDisplay = document.getElementById('current-zip');
            zipDisplay.textContent = ` (${currentZipCode})`;
        }
        
        // Location update function
        async function updateLocation() {
            const zipcode = document.getElementById('zipcode').value.trim();
            if (zipcode.length === 5 && /^\d{5}$/.test(zipcode)) {
                try {
                    // Try multiple geocoding services for better reliability
                    let coordinates = null;
                    
                    // First try: zippopotam.us
                    try {
                        const response = await fetch(`https://api.zippopotam.us/us/${zipcode}`);
                        if (response.ok) {
                            const data = await response.json();
                            coordinates = {
                                lat: parseFloat(data.places[0].latitude),
                                lng: parseFloat(data.places[0].longitude)
                            };
                        }
                    } catch (error) {
                        console.log('zippopotam.us failed, trying alternative...');
                    }
                    
                    // Second try: OpenCage Geocoding API (free tier)
                    if (!coordinates) {
                        try {
                            const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${zipcode}&countrycode=us&limit=1&no_annotations=1`);
                            if (response.ok) {
                                const data = await response.json();
                                if (data.results && data.results.length > 0) {
                                    coordinates = {
                                        lat: data.results[0].geometry.lat,
                                        lng: data.results[0].geometry.lng
                                    };
                                }
                            }
                        } catch (error) {
                            console.log('OpenCage failed, trying manual lookup...');
                        }
                    }
                    
                    // Third try: Manual lookup for common ZIP codes
                    if (!coordinates) {
                        const manualZips = {
                            '05753': { lat: 43.9998, lng: -73.1671 }, // Middlebury, VT
                            '10001': { lat: 40.7505, lng: -73.9965 }, // New York, NY
                            '90210': { lat: 34.1030, lng: -118.4105 }, // Beverly Hills, CA
                            '33101': { lat: 25.7617, lng: -80.1918 }, // Miami, FL
                            '60601': { lat: 41.8781, lng: -87.6298 }, // Chicago, IL
                            '77001': { lat: 29.7604, lng: -95.3698 }, // Houston, TX
                            '85001': { lat: 33.4484, lng: -112.0740 }, // Phoenix, AZ
                            '98101': { lat: 47.6062, lng: -122.3321 }, // Seattle, WA
                            '80201': { lat: 39.7392, lng: -104.9903 }, // Denver, CO
                            '02101': { lat: 42.3601, lng: -71.0589 }  // Boston, MA
                        };
                        
                        if (manualZips[zipcode]) {
                            coordinates = manualZips[zipcode];
                        }
                    }
                    
                    if (coordinates) {
                        currentLocation = coordinates;
                        currentZipCode = zipcode;
                        updateZipDisplay();
                        
                        // Hide the input container after successful update
                        document.getElementById('location-input-container').classList.add('hidden');
                        
                        // Clear the input field
                        document.getElementById('zipcode').value = '';
                        
                        // Update weather data for new location
                        getWeatherData(currentLocation.lat, currentLocation.lng);
                    } else {
                        throw new Error('Could not find coordinates for ZIP code');
                    }
                    
                } catch (error) {
                    console.error('Error converting ZIP code:', error);
                    alert(`Unable to find location for ZIP code ${zipcode}. Please try a different ZIP code or check your internet connection.`);
                }
            } else {
                alert('Please enter a valid 5-digit ZIP code.');
            }
        }
        
        // Handle Enter key in ZIP code input
        document.getElementById('zipcode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                updateLocation();
            }
        });
        
        // Use a different ID for the update button to avoid conflicts
        document.getElementById('update-zip-btn').addEventListener('click', updateLocation);

        document.getElementById('change-zip-btn').addEventListener('click', () => {
            document.getElementById('location-input-container').classList.toggle('hidden');
        });
        
        // NWS API Functions
        async function getWeatherData(lat = currentLocation.lat, lng = currentLocation.lng) {
            try {
                // Get grid points for the location
                const pointsResponse = await fetch(`${NWS_API_BASE}/points/${lat},${lng}`);
                const pointsData = await pointsResponse.json();
                
                // Get current conditions
                const properties = pointsData.properties;
                const forecastUrl = properties.forecast;
                const forecastHourlyUrl = properties.forecastHourly;
                
                // Fetch forecast data
                const forecastResponse = await fetch(forecastUrl);
                const forecastData = await forecastResponse.json();
                
                // Fetch hourly forecast for current conditions
                const hourlyResponse = await fetch(forecastHourlyUrl);
                const hourlyData = await hourlyResponse.json();
                
                displayWeatherData(forecastData, hourlyData, lat, lng);
                getAlerts(properties.forecastZone);
                
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('weather-info').innerHTML = '<p>Weather data unavailable</p>';
                document.getElementById('forecast-info').innerHTML = '<p>Forecast unavailable</p>';
            }
        }
        
        function displayWeatherData(forecastData, hourlyData, lat, lng) {
            // Display current conditions from hourly forecast
            const currentPeriod = hourlyData.properties.periods[0];
            const weatherInfo = document.getElementById('weather-info');
            
            weatherInfo.innerHTML = `
                <div class="current-weather">
                    <div class="temp">${currentPeriod.temperature}°${currentPeriod.temperatureUnit}</div>
                    <div class="description">${currentPeriod.shortForecast}</div>
                    <div class="details">
                        <span>Wind: ${currentPeriod.windSpeed} ${currentPeriod.windDirection}</span>
                        <span>Humidity: ${currentPeriod.relativeHumidity?.value || 'N/A'}%</span>
                    </div>
                </div>
            `;
            
            // Display 7-day forecast
            const forecastInfo = document.getElementById('forecast-info');
            const periods = forecastData.properties.periods.slice(0, 14);
            const forecastLink = `https://forecast.weather.gov/MapClick.php?lat=${lat}&lon=${lng}&FcstType=graphical`;
            
            let forecastHTML = '<div class="forecast-grid">';
            periods.forEach(period => {
                const date = new Date(period.startTime);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const isDay = period.isDaytime;
                
                let displayName;
                if (period.name.includes('Night')) {
                    displayName = `${dayName} N.`;
                } else if (period.name.includes('Today') || period.name.includes('This Afternoon')) {
                    displayName = 'Today';
                } else {
                    displayName = dayName;
                }

                forecastHTML += `
                    <a href="${forecastLink}" target="_blank" class="forecast-link">
                        <div class="forecast-day ${isDay ? 'day' : 'night'}">
                            <div class="day-name">${displayName}</div>
                            <img src="${period.icon}" alt="${period.shortForecast}" class="weather-icon">
                            <div class="temp">${period.temperature}°${period.temperatureUnit}</div>
                        </div>
                    </a>
                `;
            });
            forecastHTML += '</div>';
            
            forecastInfo.innerHTML = forecastHTML;
        }

        async function getAlerts(zoneId) {
            try {
                const alertsResponse = await fetch(`https://api.weather.gov/alerts/active/zone/${zoneId.split('/').pop()}`);
                const alertsData = await alertsResponse.json();
                displayAlerts(alertsData.features);
            } catch (error) {
                console.error('Error fetching alerts:', error);
                document.getElementById('alerts-container').innerHTML = '';
            }
        }

        function displayAlerts(alerts) {
            const alertsContainer = document.getElementById('alerts-container');
            alertsContainer.innerHTML = '';

            if (alerts && alerts.length > 0) {
                alerts.forEach(alert => {
                    const properties = alert.properties;
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert-item ${properties.severity.toLowerCase()}`;
                    alertDiv.innerHTML = `
                        <div class="alert-content">
                            <strong>${properties.event}:</strong> ${properties.headline}
                        </div>
                        <button class="alert-close" onclick="this.parentElement.remove()">×</button>
                    `;
                    alertsContainer.appendChild(alertDiv);
                });
            }
        }

        // --- SATELLITE ANIMATION ---

        const animationData = new Map();
        const ANIMATION_DELAY = 1000; // 1 second per frame
        const FRAME_COUNT = 24; // 24 frames = ~4 hours of animation

        function initializeAnimations() {
            document.querySelectorAll('.satellite-item').forEach((item, index) => {
                const band = item.dataset.band;
                const sector = item.dataset.sector;
                
                if (!animationData.has(index)) {
                    animationData.set(index, {
                        band: band,
                        sector: sector,
                        frames: [],
                        currentFrame: 0,
                        animationInterval: null
                    });
                }

                loadLatestImage(index);
            });
        }

        async function loadLatestImage(index) {
            const data = animationData.get(index);
            if (!data) return;

            const img = document.querySelectorAll('.satellite-item')[index].querySelector('img');
            stopAnimationLoop(index);

            try {
                const now = new Date();
                const frames = [];

                // CONUS products update every 5 minutes, others every 10
                const intervalMinutes = data.sector === 'CONUS' ? 5 : 10;

                // Start from 30 minutes ago to ensure images are available
                const startTime = new Date(now.getTime() - (30 * 60 * 1000));

                for (let i = 0; i < FRAME_COUNT; i++) {
                    // Go backwards in time: subtract the interval for each frame
                    const timestamp = new Date(startTime.getTime() - (i * intervalMinutes * 60 * 1000));
                    
                    const year = timestamp.getUTCFullYear();
                    const startOfYear = new Date(Date.UTC(year, 0, 1));
                    const dayOfYear = Math.floor((timestamp.getTime() - startOfYear.getTime()) / (1000 * 60 * 60 * 24)) + 1;
                    const hour = timestamp.getUTCHours();
                    
                    // NOAA uses a specific 5-minute interval pattern: 01, 06, 11, 16, 21, 26, 31, 36, 41, 46, 51, 56
                    let minute;
                    if (data.sector === 'CONUS') {
                        // For CONUS: round to nearest 5-minute interval starting from 01
                        const rawMinute = timestamp.getUTCMinutes();
                        const intervalIndex = Math.floor(rawMinute / 5);
                        minute = (intervalIndex * 5) + 1;
                        if (minute >= 60) minute = 1; // Wrap around
                    } else {
                        // For FD: round to nearest 10-minute interval
                        minute = Math.floor(timestamp.getUTCMinutes() / 10) * 10;
                    }
                    
                    const timestampStr = `${year}${dayOfYear.toString().padStart(3, '0')}${hour.toString().padStart(2, '0')}${minute.toString().padStart(2, '0')}`;
                    
                    // Handle different resolution for CONUS images
                    const resolution = data.sector === 'CONUS' ? '2500x1500' : '1808x1808';
                    const imageUrl = `https://cdn.star.nesdis.noaa.gov/GOES19/ABI/${data.sector}/${data.band}/${timestampStr}_GOES19-ABI-${data.sector}-${data.band}-${resolution}.jpg`;
                    frames.push(imageUrl);
                }

                data.frames = frames.reverse();
                data.currentFrame = 0;

                const testImg = new Image();
                testImg.onload = () => {
                    img.src = testImg.src;
                    startAnimationLoop(index);
                };
                testImg.onerror = () => {
                    console.error(`Initial frame load failed for ${data.band}. URL: ${testImg.src}`);
                    img.src = '';
                };

                if (data.frames.length > 0) {
                    testImg.src = data.frames[0];
                }

            } catch (error) {
                console.error(`Failed to load images for band ${data.band}:`, error);
                img.src = '';
            }
        }

        function startAnimationLoop(index) {
            const data = animationData.get(index);
            if (!data || !data.frames || data.frames.length === 0 || data.animationInterval) return;

            const visibleImg = document.querySelectorAll('.satellite-item')[index].querySelector('img');

            const showNextFrame = () => {
                const nextFrameIndex = (data.currentFrame + 1) % data.frames.length;
                
                const nextImage = new Image();
                nextImage.src = data.frames[nextFrameIndex];

                nextImage.onload = () => {
                    visibleImg.src = nextImage.src;
                    data.currentFrame = nextFrameIndex;
                    data.animationInterval = setTimeout(showNextFrame, ANIMATION_DELAY);
                };

                nextImage.onerror = () => {
                    console.error(`Failed to load frame ${nextFrameIndex} for ${data.band}. URL: ${nextImage.src}. Skipping.`);
                    // Advance the frame counter and schedule the next frame attempt
                    data.currentFrame = nextFrameIndex;
                    data.animationInterval = setTimeout(showNextFrame, ANIMATION_DELAY);
                };
            };

            // Start the loop
            data.animationInterval = setTimeout(showNextFrame, ANIMATION_DELAY);
        }

        function stopAnimationLoop(index) {
            const data = animationData.get(index);
            if (data && data.animationInterval) {
                clearTimeout(data.animationInterval);
                data.animationInterval = null;
            }
        }

        document.querySelectorAll('.satellite-item').forEach((item, index) => {
            item.addEventListener('mouseenter', () => stopAnimationLoop(index));
            item.addEventListener('mouseleave', () => startAnimationLoop(index));
        });

        window.addEventListener('load', () => {
            updateZipDisplay();
            getWeatherData();
            setTimeout(initializeAnimations, 500);
        });
        
        setInterval(getWeatherData, 30 * 60 * 1000);
        
        // Refresh animations every 15 minutes
        setInterval(initializeAnimations, 15 * 60 * 1000);

        // --- FORECAST MAP ANIMATION ---
        function detectForecastImages(element, callback) {
            const baseUrl = 'https://graphical.weather.gov/GraphicalNDFD.php';
            const sector = 'CONUS';
            const timezone = 'EDT';
            const width = 515;
            const urls = [];
            let n = 1;
            let maxTries = 10;
            function tryNext() {
                if (n > maxTries) {
                    callback(urls);
                    return;
                }
                const url = `${baseUrl}?width=${width}&timezone=${timezone}&sector=${sector}&element=${element}&n=${n}`;
                const img = new window.Image();
                img.style.display = 'none';
                img.onload = function() {
                    urls.push(url);
                    n++;
                    tryNext();
                };
                img.onerror = function() {
                    callback(urls);
                };
                document.body.appendChild(img); // Needed for some browsers to trigger load/error
                img.src = url;
            }
            tryNext();
        }

        function startForecastAnimations() {
            const tempImg = document.getElementById('temp-forecast-anim');
            const precipImg = document.getElementById('precip-forecast-anim');
            if (!tempImg || !precipImg) return;

            detectForecastImages('maxt', function(tempUrls) {
                detectForecastImages('pop12', function(precipUrls) {
                    const frameCount = Math.min(tempUrls.length, precipUrls.length);
                    let index = 0;

                    function animateBoth() {
                        if (frameCount > 0) {
                            tempImg.src = tempUrls[index];
                            precipImg.src = precipUrls[index];
                            index = (index + 1) % frameCount;
                        }
                    }

                    animateBoth();
                    setInterval(animateBoth, 1000);
                });
            });
        }

        window.addEventListener('load', () => {
            startForecastAnimations();
        });
    </script>
</body>
<footer class="weather-footer">
    Created by <a href="https://hromp.com" target="_blank">hromp.com</a>
</footer>
</html>